# プラン変更チェック処理フロー

```mermaid
flowchart TD
    Start([初期処理])
    Start --> A[認可排他チェック]
    A --> B[契約状態チェック]
    B --> C[今月請求チェック（即時プラン変更）]
    C --> D[サービスマスタチェック]
    D --> E[プランマスタチェック]
    E --> F[APIパラメータチェック]
    F --> G[整合性チェック]
    G --> H[メンテナンスチェック]
    H --> I[APIプラン変更チェック]
    I --> J{チェック結果}
    J -- NG --> End1[終了処理]
    J -- OK --> K[処理モードチェック]
    K --> L[RP要求履歴登録（リクエスト）]
    L --> M[RP要求履歴登録（レスポンス）]
    M --> N[契約共通処理]
    N --> O[契約請求情報取得]
    O --> P[プラン変更請求情報取得]
    P --> Q[契約詳細参照API]
    Q --> R[現契約情報取得]
    R --> S[排他ID取得]
    S --> T[適用中クーポン情報取得]
    T --> U[適用予定クーポン情報取得]
    U --> V[無料延長クーポン情報取得]
    V --> W[操作可否チェック]
    W --> X{操作結果}
    X -- NG --> End2[終了処理]
    X -- OK --> Y[返却オブジェクト設定]
    Y --> Z[応答電文作成]
    Z --> End([結果応答])

    subgraph ロールバック
        Rollback1[ロールバックケース]
    end

    subgraph メール処理
        Mail1[メール送信ケース]
    end

    subgraph 凡例
        LoopStart[[ループ(開始)]]
        LoopEnd[[ループ(終了)]]
    end
```
